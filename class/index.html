<!-- class/index.html -->
<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 預設（無 id 時） -->
  <title>課程｜Eduvia</title>
  <meta name="description" content="探索 Eduvia 熱門課程：Python、AI、資料分析、前端工程等。" />
  <link rel="canonical" href="${import.meta.env.VITE_SITE_URL}/class/" />
  <meta property="og:site_name" content="${import.meta.env.VITE_SITE_NAME}">
  <meta property="og:type" content="website">
  <meta property="og:title" content="課程｜Eduvia">
  <meta property="og:description" content="探索 Eduvia 熱門課程：Python、AI、資料分析、前端工程等。">
  <meta property="og:image" content="${import.meta.env.VITE_OG_IMAGE}">
  <meta property="og:url" content="${import.meta.env.VITE_SITE_URL}/class/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="${import.meta.env.VITE_TWITTER}">

  <script type="module">
    // 解析 /class/:id/；兼容 ?id= 的過渡情境
    const m = location.pathname.match(/^\/class\/([^/]+)\/?$/);
    const id = m?.[1] || new URL(location.href).searchParams.get("id");

    // 若是以 /class/?id=… 進來，先把網址「換皮」成 /class/:id/（不重整）
    if (!m && id) {
      const pretty = `/class/${encodeURIComponent(id)}/` + (location.hash || "");
      history.replaceState(null, "", pretty);
    }

    // 小工具：覆寫(或建立) head 內容
    function setMeta(name, content) {
      if (!content) return;
      let el = document.querySelector(`meta[name="${name}"]`);
      if (!el) { el = document.createElement('meta'); el.setAttribute('name', name); document.head.appendChild(el); }
      el.setAttribute('content', content);
    }
    function setOG(property, content) {
      if (!content) return;
      let el = document.querySelector(`meta[property="${property}"]`);
      if (!el) { el = document.createElement('meta'); el.setAttribute('property', property); document.head.appendChild(el); }
      el.setAttribute('content', content);
    }
    function setCanonical(href) {
      if (!href) return;
      let el = document.querySelector('link[rel="canonical"]');
      if (!el) { el = document.createElement('link'); el.setAttribute('rel', 'canonical'); document.head.appendChild(el); }
      el.setAttribute('href', href);
    }

    async function applyCourseHead(course) {
      const site = (import.meta.env.VITE_SITE_URL || "").replace(/\/+$/, "");
      const url = `${site}/class/${course.id}/`;
      const name = import.meta.env.VITE_SITE_NAME || "";
      const ogFallback = import.meta.env.VITE_OG_IMAGE || "";
      const title = `${course.title}｜${name}`;
      const desc = course.seoDescription || course.summary || import.meta.env.VITE_SITE_DESC || "";

      document.title = title;
      setMeta('description', desc);
      setCanonical(url);

      setOG('og:type', 'article');
      setOG('og:title', title);
      setOG('og:description', desc);
      setOG('og:url', url);
      setOG('og:image', course.ogImage || ogFallback);

      // JSON-LD（Course + 可選 VideoObject）
      const ld = {
        "@context": "https://schema.org",
        "@type": "Course",
        "name": course.title,
        "description": desc,
        "provider": { "@type": "Organization", "name": name, "sameAs": site || undefined },
        "aggregateRating": course.rating ? {
          "@type": "AggregateRating",
          "ratingValue": Number(course.rating).toFixed(1),
          "reviewCount": course.ratingCount || 0
        } : undefined
      };
      if (course.video && course.video.url) {
        ld.hasCourseInstance = {
          "@type": "CourseInstance",
          "courseMode": "online",
          "location": { "@type": "VirtualLocation", "url": url },
          "video": {
            "@type": "VideoObject",
            "name": course.title + " 預覽",
            "thumbnailUrl": course.video.thumb || ogFallback,
            "uploadDate": course.video.uploadDate || undefined,
            "contentUrl": course.video.url
          }
        };
      }
      const s = document.createElement('script');
      s.type = 'application/ld+json';
      s.textContent = JSON.stringify(ld);
      document.head.appendChild(s);
    }

    (async () => {
      if (!id) return; // 無 id：保留預設 head
      try {
        // 先用靜態資料：/public/courses/<id>.json
        const res = await fetch(`/courses/${id}.json`, { cache: 'no-store' });
        if (!res.ok) return;
        const c = await res.json();
        if (c && c.id) await applyCourseHead(c);
      } catch { }
    })();
  </script>
</head>

<body>
  <div id="app"></div>
  <script type="module" src="/src/class-main.js"></script>
</body>

</html>